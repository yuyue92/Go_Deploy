<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>é¡¹ç›®ä¸ä»»åŠ¡ç®¡ç†</title>
<style>
:root{
  /* Bootstrap-like palette */
  --bs-body-bg:#f8f9fa;
  --bs-body-color:#212529;
  --bs-border:#dee2e6;
  --bs-primary:#0d6efd;
  --bs-primary-hover:#0b5ed7;
  --bs-secondary:#6c757d;
  --bs-success:#198754;
  --bs-success-100:#d1e7dd;
  --bs-success-800:#0f5132;
  --bs-warning:#ffc107;
  --bs-warning-100:#fff3cd;
  --bs-warning-800:#664d03;
  --bs-danger:#dc3545;
  --bs-danger-100:#f8d7da;
  --bs-danger-800:#842029;
  --bs-info:#0dcaf0;
  --bs-info-100:#cff4fc;
  --bs-info-800:#055160;
  --bs-primary-100:#cfe2ff;
  --bs-primary-800:#084298;
  --radius:.5rem;
  --shadow-sm:0 .125rem .25rem rgba(0,0,0,.075);
  --shadow:0 .5rem 1rem rgba(0,0,0,.15);
  --gap:.75rem;
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial;
  color:var(--bs-body-color); background:var(--bs-body-bg);
}

/* Layout */
.container{max-width:1400px;margin:0 auto;padding:12px}
.row{display:flex;gap:var(--gap);flex-wrap:wrap;align-items:center}
h1{font-size:18px;margin:0;letter-spacing:.2px;font-weight:600}
h2{font-size:16px;margin:0 0 12px;font-weight:600}
a{color:var(--bs-primary);text-decoration:none}
a:hover{text-decoration:underline}

/* ç´§å‡‘å‹Header */
header{
  position:sticky; top:0; z-index:5; background:#fff;
  border-bottom:1px solid var(--bs-border); box-shadow:var(--shadow-sm);
  padding:8px 0;
}
header .container{padding:0 16px}
kbd{background:#e9ecef;color:#495057;border:1px solid var(--bs-border);padding:2px 6px;border-radius:.375rem;font-size:12px}

.badge{
  display:inline-flex;align-items:center;gap:6px;padding:.25em .5em;border-radius:.375rem;
  background:#e9ecef;color:#495057;border:1px solid var(--bs-border);font-size:12px
}

/* å·¦å³åˆ†æ å¸ƒå±€ */
.split-layout{
  display:grid;
  grid-template-columns:400px 1fr;
  gap:16px;
  height:calc(100vh - 70px);
  overflow:hidden;
}

.panel-left, .panel-right{
  display:flex;
  flex-direction:column;
  overflow:hidden;
}

/* Cards */
.card{
  background:#fff;border:1px solid var(--bs-border); border-radius:var(--radius); 
  box-shadow:var(--shadow-sm);
  display:flex;
  flex-direction:column;
  height:100%;
}
.toolbar{
  display:flex;gap:var(--gap);align-items:center;flex-wrap:wrap;
  padding:10px 12px;border-bottom:1px solid var(--bs-border); background:#fff;
  border-top-left-radius:var(--radius);border-top-right-radius:var(--radius);
  flex-shrink:0;
}
.tools-right{margin-left:auto;display:flex;gap:var(--gap);align-items:center;flex-wrap:wrap}

/* Inputs */
.input, select, textarea{
  background:#fff;border:1px solid #ced4da; color:var(--bs-body-color);
  padding:.375rem .75rem;border-radius:.375rem; outline:none; min-height:38px;
  transition:border-color .15s ease, box-shadow .15s ease;
}
.input::placeholder{color:#6c757d}
.input:focus, select:focus, textarea:focus{
  border-color:var(--bs-primary);
  box-shadow:0 0 0 .25rem rgba(13,110,253,.25);
}

/* Buttons */
.button{
  display:inline-block; font-weight:500; color:#fff; background:var(--bs-primary);
  border:1px solid var(--bs-primary); padding:.375rem .75rem; border-radius:.375rem; cursor:pointer;
  transition:background-color .15s ease, border-color .15s ease, transform .06s ease;
  white-space:nowrap;
}
.button:hover{background:var(--bs-primary-hover); border-color:var(--bs-primary-hover)}
.button:active{transform:translateY(1px)}
.button.small{padding:.25rem .5rem;border-radius:.25rem;font-size:13px}

.button.ghost{background:transparent;color:var(--bs-secondary);border:1px solid var(--bs-secondary)}
.button.ghost:hover{background:var(--bs-secondary);color:#fff}

.button.warn{background:var(--bs-warning);border-color:var(--bs-warning);color:#212529}
.button.warn:hover{background:#e0ac07;border-color:#e0ac07}
.button.danger{background:var(--bs-danger);border-color:var(--bs-danger)}
.button.danger:hover{background:#bb2d3b;border-color:#bb2d3b}
.button.ok{background:var(--bs-success);border-color:var(--bs-success)}
.button.ok:hover{background:#157347;border-color:#157347}

/* Tables */
.table-wrap{overflow:auto;flex:1}
table{width:100%;border-collapse:collapse}
th,td{padding:.75rem;border-bottom:1px solid var(--bs-border);vertical-align:top}
th{
  position:sticky;top:0;background:#f1f3f5;z-index:1;text-align:left;font-weight:600;color:#495057
}
tbody tr:nth-child(odd){background:#fafbfc}
tbody tr:hover{background:#eef3ff}
tbody tr.clickable{cursor:pointer}
tbody tr.selected{background:#e7f3ff;border-left:3px solid var(--bs-primary)}

/* æ–‡æœ¬æº¢å‡ºçœç•¥ */
.text-ellipsis{
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
  max-width:100%;
}
.text-ellipsis-2{
  overflow:hidden;
  text-overflow:ellipsis;
  display:-webkit-box;
  -webkit-line-clamp:2;
  -webkit-box-orient:vertical;
  line-height:1.4;
  max-height:2.8em;
}
@media screen and (max-width: 2600px) {
  .project-name-cell, .task-name-cell{
    max-width:180px;
  }
}
@media screen and (max-width: 1400px) {
  .project-name-cell, .task-name-cell{
    max-width:250px;
  }
}
.project-name-cell strong, .task-name-cell strong{
  display:block;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}
.project-name-cell .help, .task-name-cell .help{
  display:block;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
  margin-top:2px;
}

/* Status & Priority pills */
.status{display:inline-block;padding:.25rem .5rem;border-radius:999px;border:1px solid var(--bs-border);font-weight:600;font-size:12px}
.status.planned{background:#e9ecef;color:#6c757d}
.status.active{background:var(--bs-success-100);color:var(--bs-success-800)}
.status.paused{background:var(--bs-warning-100);color:var(--bs-warning-800)}
.status.completed{background:var(--bs-primary-100);color:var(--bs-primary-800)}
.status.canceled{background:var(--bs-danger-100);color:var(--bs-danger-800)}
.status.todo{background:#e9ecef;color:#6c757d}
.status.doing{background:var(--bs-info-100);color:var(--bs-info-800)}
.status.done{background:var(--bs-success-100);color:var(--bs-success-800)}
.status.blocked{background:var(--bs-danger-100);color:var(--bs-danger-800)}
.priority.low{color:#6c757d}
.priority.medium{color:#fd7e14}
.priority.high{color:var(--bs-danger)}
.priority.urgent{color:#b21f2d}

/* Pager */
.pager{display:flex;gap:8px;align-items:center;padding:10px 12px;border-top:1px solid var(--bs-border);background:#fff;border-bottom-left-radius:var(--radius);border-bottom-right-radius:var(--radius);flex-shrink:0}
.pill{display:inline-flex;align-items:center;gap:8px;padding:.25rem .5rem;border-radius:999px;background:#f1f3f5;border:1px solid var(--bs-border)}
.meta{color:#6c757d;font-size:13px}

/* Loading Spinner */
.loading-overlay{
  position:fixed;
  inset:0;
  background:rgba(255,255,255,0.8);
  display:none;
  place-items:center;
  z-index:100;
}
.loading-overlay.show{display:grid}
.spinner{
  width:50px;
  height:50px;
  border:4px solid #f3f3f3;
  border-top:4px solid var(--bs-primary);
  border-radius:50%;
  animation:spin 1s linear infinite;
}
@keyframes spin{
  0%{transform:rotate(0deg)}
  100%{transform:rotate(360deg)}
}

/* åŒºåŸŸåŠ è½½æç¤º */
.section-loading{
  display:none;
  padding:40px;
  text-align:center;
  color:#6c757d;
}
.section-loading.show{display:block}
.section-loading .mini-spinner{
  display:inline-block;
  width:24px;
  height:24px;
  border:3px solid #f3f3f3;
  border-top:3px solid var(--bs-primary);
  border-radius:50%;
  animation:spin 0.8s linear infinite;
  margin-right:8px;
  vertical-align:middle;
}

/* Toast */
.toast{position:fixed;right:18px;bottom:18px;z-index:200;display:flex;flex-direction:column;gap:10px}
.toast .t{padding:.5rem .75rem;border-radius:.5rem;background:#fff;border:1px solid var(--bs-border);box-shadow:var(--shadow-sm);color:#212529}
.t.ok{border-left:4px solid var(--bs-success)}
.t.err{border-left:4px solid var(--bs-danger)}

/* Modal */
.modal{
  position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.4);z-index:150;
}
.modal[data-open="1"]{display:grid}
.modal .panel{
  width:min(760px,92vw);background:#fff;border:1px solid var(--bs-border);border-radius:.75rem;box-shadow:var(--shadow)
}
.panel header{display:flex;align-items:center;justify-content:space-between;padding:.75rem .875rem;border-bottom:1px solid var(--bs-border)}
.panel .body{padding:14px;max-height:70vh;overflow:auto}
.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
.col-6{grid-column:span 6}
.col-4{grid-column:span 4}
.col-3{grid-column:span 3}
.col-12{grid-column:span 12}
.form-row{display:flex;flex-direction:column;gap:6px}
label{color:#495057;font-weight:500}

.api-box{display:flex;gap:8px;align-items:center;background:#fff;border:1px solid var(--bs-border);padding:4px 8px;border-radius:.375rem}
.api-box input{all:unset;background:transparent;color:#212529;font-size:13px}
.help{color:#6c757d;font-size:13px}
hr.sep{border:0;border-top:1px solid var(--bs-border);margin:10px 0}

/* ç©ºçŠ¶æ€ */
.empty-state{
  padding:60px 20px;
  text-align:center;
  color:#6c757d;
}
.empty-state h3{color:#495057;margin-bottom:8px}

/* å“åº”å¼ */
@media (max-width:1024px){
  .split-layout{
    grid-template-columns:1fr;
    height:auto;
  }
  .panel-right{
    margin-top:16px;
  }
}
</style>

</head>
<body>
<!-- Loading Overlay -->
<div class="loading-overlay" id="globalLoading">
  <div class="spinner"></div>
</div>

<!-- Header -->
<header>
  <div class="container row">
    <h1>é¡¹ç›®ä¸ä»»åŠ¡ç®¡ç†</h1>
    <div class="tools-right">
      <div class="api-box">
        <span class="help">API</span>
        <input id="apiBase" placeholder="http://localhost:8080" size="24" />
        <button class="button small ghost" id="saveApi">ä¿å­˜</button>
      </div>
      <button class="button small ghost" id="seedBtn">ç¤ºä¾‹æ•°æ®</button>
      <a class="button small" href="#docs" id="openDocs">APIæ–‡æ¡£</a>
    </div>
  </div>
</header>

<!-- ä¸»ä½“ï¼šå·¦å³åˆ†æ  -->
<div class="container">
  <div class="split-layout">
    
    <!-- å·¦ä¾§ï¼šé¡¹ç›®åˆ—è¡¨ -->
    <div class="panel-left">
      <div class="card">
        <div class="toolbar">
          <h2>é¡¹ç›®åˆ—è¡¨</h2>
          <div class="tools-right">
            <button class="button small" id="p-new">æ–°å»º</button>
            <button class="button small ghost" id="p-refresh">åˆ·æ–°</button>
          </div>
        </div>
        
        <!-- é¡¹ç›®ç­›é€‰ -->
        <div style="padding:10px 12px;border-bottom:1px solid var(--bs-border);background:#fafbfc">
          <div class="row" style="gap:8px">
            <input class="input" id="p-q" placeholder="æœç´¢é¡¹ç›®åç§°" style="flex:1;min-height:32px" />
            <select class="input" id="p-status" style="min-height:32px">
              <option value="">å…¨éƒ¨çŠ¶æ€</option>
              <option value="planned">planned</option>
              <option value="active">active</option>
              <option value="paused">paused</option>
              <option value="completed">completed</option>
              <option value="canceled">canceled</option>
            </select>
          </div>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th width="60">ID</th>
                <th>é¡¹ç›®åç§°</th>
                <th width="90">çŠ¶æ€</th>
                <th width="90">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="p-table"></tbody>
          </table>
        </div>

        <div class="pager">
          <button class="button small ghost" id="p-prev">ä¸Šä¸€é¡µ</button>
          <span class="meta" id="p-meta">0-0 / 0</span>
          <button class="button small ghost" id="p-next">ä¸‹ä¸€é¡µ</button>
          <select class="input" id="p-limit" style="min-height:32px;margin-left:auto">
            <option value="10">10æ¡/é¡µ</option>
            <option value="20" selected>20æ¡/é¡µ</option>
            <option value="50">50æ¡/é¡µ</option>
          </select>
        </div>
      </div>
    </div>

    <!-- å³ä¾§ï¼šä»»åŠ¡åˆ—è¡¨ -->
    <div class="panel-right">
      <div class="card">
        <div class="toolbar">
          <h2 id="task-title">é€‰æ‹©é¡¹ç›®æŸ¥çœ‹ä»»åŠ¡</h2>
          <div class="tools-right">
            <button class="button small" id="t-new" disabled>æ–°å»ºä»»åŠ¡</button>
            <button class="button small ghost" id="t-refresh" disabled>åˆ·æ–°</button>
          </div>
        </div>

        <!-- ä»»åŠ¡ç­›é€‰ -->
        <div style="padding:10px 12px;border-bottom:1px solid var(--bs-border);background:#fafbfc">
          <div class="row" style="gap:8px;margin-bottom:8px">
            <input class="input" id="t-q" placeholder="æœç´¢ä»»åŠ¡" style="flex:1;min-height:32px" />
            <select class="input" id="t-status" style="min-height:32px">
              <option value="">å…¨éƒ¨çŠ¶æ€</option>
              <option value="todo">todo</option>
              <option value="doing">doing</option>
              <option value="done">done</option>
              <option value="blocked">blocked</option>
            </select>
            <select class="input" id="t-priority" style="min-height:32px">
              <option value="">å…¨éƒ¨ä¼˜å…ˆçº§</option>
              <option value="low">low</option>
              <option value="medium">medium</option>
              <option value="high">high</option>
              <option value="urgent">urgent</option>
            </select>
          </div>
          <div class="row" style="gap:8px">
            <input class="input" id="t-after" type="date" placeholder="æˆªæ­¢æ—¥æœŸå¼€å§‹" style="min-height:32px" />
            <input class="input" id="t-before" type="date" placeholder="æˆªæ­¢æ—¥æœŸç»“æŸ" style="min-height:32px" />
            <select class="input" id="t-sort" style="min-height:32px">
              <option value="created_at">åˆ›å»ºæ—¶é—´</option>
              <option value="due_date">æˆªæ­¢æ—¥æœŸ</option>
              <option value="priority">ä¼˜å…ˆçº§</option>
            </select>
          </div>
        </div>

        <!-- åŠ è½½æç¤º -->
        <div class="section-loading" id="t-loading">
          <div class="mini-spinner"></div>
          <span>åŠ è½½ä»»åŠ¡ä¸­...</span>
        </div>

        <!-- ç©ºçŠ¶æ€ -->
        <div class="empty-state" id="t-empty" style="display:none">
          <h3>ğŸ‘ˆ è¯·åœ¨å·¦ä¾§é€‰æ‹©ä¸€ä¸ªé¡¹ç›®</h3>
          <p>é€‰æ‹©é¡¹ç›®åå³å¯æŸ¥çœ‹è¯¥é¡¹ç›®ä¸‹çš„æ‰€æœ‰ä»»åŠ¡</p>
        </div>

        <div class="table-wrap" id="t-table-wrap" style="display:none">
          <table>
            <thead>
              <tr>
                <th width="60">ID</th>
                <th>ä»»åŠ¡åç§°</th>
                <th width="80">çŠ¶æ€</th>
                <th width="80">ä¼˜å…ˆçº§</th>
                <th width="120">é¢„ä¼°/å®é™…(h)</th>
                <th width="120">æˆªæ­¢æ—¥æœŸ</th>
                <th width="220">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="t-table"></tbody>
          </table>
        </div>

        <div class="pager" id="t-pager" style="display:none">
          <button class="button small ghost" id="t-prev">ä¸Šä¸€é¡µ</button>
          <span class="meta" id="t-meta">0-0 / 0</span>
          <button class="button small ghost" id="t-next">ä¸‹ä¸€é¡µ</button>
          <select class="input" id="t-limit" style="min-height:32px;margin-left:auto">
            <option value="10">10æ¡/é¡µ</option>
            <option value="20" selected>20æ¡/é¡µ</option>
            <option value="50">50æ¡/é¡µ</option>
          </select>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Modalï¼šé¡¹ç›®è¡¨å• -->
<div class="modal" id="modal-project">
  <div class="panel">
    <header>
      <strong id="mp-title">æ–°å»ºé¡¹ç›®</strong>
      <button class="button small ghost" onclick="modalClose('#modal-project')">âœ•</button>
    </header>
    <div class="body">
      <form id="mp-form">
        <input type="hidden" name="sqlid" />
        <div class="grid">
          <div class="col-12 form-row">
            <label>é¡¹ç›®åç§°*</label>
            <input class="input" name="name" required />
          </div>
          <div class="col-6 form-row">
            <label>çŠ¶æ€*</label>
            <select class="input" name="status" required>
              <option value="planned">planned</option>
              <option value="active">active</option>
              <option value="paused">paused</option>
              <option value="completed">completed</option>
              <option value="canceled">canceled</option>
            </select>
          </div>
          <div class="col-6 form-row">
            <label>é¢„ç®—</label>
            <input class="input" name="budget" type="number" step="0.01" />
          </div>
          <div class="col-6 form-row">
            <label>å¼€å§‹æ—¥æœŸ</label>
            <input class="input" name="start_date" type="date" />
          </div>
          <div class="col-6 form-row">
            <label>æˆªæ­¢æ—¥æœŸ</label>
            <input class="input" name="deadline" type="date" />
          </div>
          <div class="col-6 form-row">
            <label>é¡¹ç›®ç»ç†ID</label>
            <input class="input" name="project_manager_id" type="number" />
          </div>
          <div class="col-6 form-row">
            <label>å®¢æˆ·ID</label>
            <input class="input" name="client_id" type="number" />
          </div>
          <div class="col-12 form-row">
            <label>æè¿°</label>
            <textarea class="input" name="description" rows="3"></textarea>
          </div>
          <div class="col-12">
            <hr class="sep" />
            <div class="row" style="justify-content:flex-end">
              <button type="button" class="button ghost" onclick="modalClose('#modal-project')">å–æ¶ˆ</button>
              <button type="submit" class="button ok">ä¿å­˜</button>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modalï¼šä»»åŠ¡è¡¨å• -->
<div class="modal" id="modal-task">
  <div class="panel">
    <header>
      <strong id="mt-title">æ–°å»ºä»»åŠ¡</strong>
      <button class="button small ghost" onclick="modalClose('#modal-task')">âœ•</button>
    </header>
    <div class="body">
      <form id="mt-form">
        <input type="hidden" name="sqlid" />
        <div class="grid">
          <div class="col-12 form-row">
            <label>æ‰€å±é¡¹ç›®ID*</label>
            <input class="input" name="sqlproject_id" type="number" required readonly />
          </div>
          <div class="col-12 form-row">
            <label>ä»»åŠ¡åç§°*</label>
            <input class="input" name="task_name" required />
          </div>
          <div class="col-6 form-row">
            <label>çŠ¶æ€*</label>
            <select class="input" name="status" required>
              <option value="todo">todo</option>
              <option value="doing">doing</option>
              <option value="done">done</option>
              <option value="blocked">blocked</option>
            </select>
          </div>
          <div class="col-6 form-row">
            <label>ä¼˜å…ˆçº§</label>
            <select class="input" name="priority">
              <option value="">æ— </option>
              <option value="low">low</option>
              <option value="medium">medium</option>
              <option value="high">high</option>
              <option value="urgent">urgent</option>
            </select>
          </div>
          <div class="col-4 form-row">
            <label>é¢„ä¼°å·¥æ—¶</label>
            <input class="input" name="estimated_hours" type="number" step="0.5" />
          </div>
          <div class="col-4 form-row">
            <label>å®é™…å·¥æ—¶</label>
            <input class="input" name="actual_hours" type="number" step="0.5" />
          </div>
          <div class="col-4 form-row">
            <label>è´Ÿè´£äººID</label>
            <input class="input" name="assignee_id" type="number" />
          </div>
          <div class="col-12 form-row">
            <label>æˆªæ­¢æ—¥æœŸ</label>
            <input class="input" name="due_date" type="date" />
          </div>
          <div class="col-12 form-row">
            <label>æè¿°</label>
            <textarea class="input" name="description" rows="3"></textarea>
          </div>
          <div class="col-12">
            <hr class="sep" />
            <div class="row" style="justify-content:flex-end">
              <button type="button" class="button ghost" onclick="modalClose('#modal-task')">å–æ¶ˆ</button>
              <button type="submit" class="button ok">ä¿å­˜</button>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Toast å®¹å™¨ -->
<div class="toast" id="toastBox"></div>

<script>
/* ========================= Utilities ========================= */
const $ = (s) => document.querySelector(s);
const $$ = (s) => document.querySelectorAll(s);

// Loading æ§åˆ¶
const showLoading = () => $("#globalLoading").classList.add("show");
const hideLoading = () => $("#globalLoading").classList.remove("show");

const showSectionLoading = (id) => $(id).classList.add("show");
const hideSectionLoading = (id) => $(id).classList.remove("show");

// Toast
function toast(msg, ok = true) {
  const box = $("#toastBox");
  const el = document.createElement("div");
  el.className = ok ? "t ok" : "t err";
  el.textContent = msg;
  box.appendChild(el);
  setTimeout(() => el.remove(), 3000);
}

// Modal
function modalOpen(sel) { $(sel).dataset.open = "1"; }
function modalClose(sel) { $(sel).dataset.open = "0"; }

// æ•°æ®è½¬æ¢
const str = (v) => v || "";
const int = (v) => v ? Number(v) : null;
const num = (v) => v ? parseFloat(v) : null;
const toISO = (d) => d ? d.split("T")[0] : "";

/* ========================= API é…ç½® ========================= */
const Api = {
  base: localStorage.getItem("apiBase") || "http://localhost:8080",
  setBase(url) {
    this.base = url.replace(/\/+$/, "");
    localStorage.setItem("apiBase", this.base);
  },
  async req(path, opts = {}) {
    const url = this.base + path;
    const res = await fetch(url, {
      headers: { "Content-Type": "application/json" },
      ...opts
    });
    if (!res.ok) {
      const txt = await res.text();
      throw new Error(`${res.status} ${txt || res.statusText}`);
    }
    return res.json();
  },
  // é¡¹ç›®
  listProjects(qs) {
    const params = new URLSearchParams();
    for (let k in qs) if (qs[k] !== "") params.set(k, qs[k]);
    return this.req("/projects?" + params);
  },
  createProject(data) { return this.req("/projects", { method: "POST", body: JSON.stringify(data) }); },
  updateProject(id, data) { return this.req(`/projects/${id}`, { method: "PUT", body: JSON.stringify(data) }); },
  deleteProject(id) { return this.req(`/projects/${id}`, { method: "DELETE" }); },
  // ä»»åŠ¡
  listTasks(qs) {
    const params = new URLSearchParams();
    for (let k in qs) if (qs[k] !== "") params.set(k, qs[k]);
    return this.req("/tasks?" + params);
  },
  createTask(data) { return this.req("/tasks", { method: "POST", body: JSON.stringify(data) }); },
  updateTask(id, data) { return this.req(`/tasks/${id}`, { method: "PUT", body: JSON.stringify(data) }); },
  deleteTask(id) { return this.req(`/tasks/${id}`, { method: "DELETE" }); },
  patchTaskStatus(id, status) { return this.req(`/tasks/${id}`, { method: "PATCH", body: JSON.stringify({ status }) }); },
};

// åˆå§‹åŒ– API åœ°å€
$("#apiBase").value = Api.base;
$("#saveApi").addEventListener("click", () => {
  const val = $("#apiBase").value.trim();
  if (val) {
    Api.setBase(val);
    toast("APIåœ°å€å·²ä¿å­˜");
  }
});

/* ========================= é¡¹ç›®ï¼šåˆ—è¡¨/åˆ†é¡µ/è¡¨å• ========================= */
const P = {
  state: { offset: 0, limit: 20, selectedProjectId: null },
  els: {
    q: $("#p-q"), status: $("#p-status"), limit: $("#p-limit"),
    refresh: $("#p-refresh"), table: $("#p-table"),
    meta: $("#p-meta"), prev: $("#p-prev"), next: $("#p-next"),
    btnNew: $("#p-new"),
  },
  qs() {
    return {
      q: P.els.q.value.trim() || "",
      status: P.els.status.value || "",
      sort: "created_at",
      limit: P.state.limit,
      offset: P.state.offset
    };
  },
  async load() {
    showLoading();
    try {
      const data = await Api.listProjects(P.qs());
      const items = data.items || [];
      P.render(items);
      P.els.meta.textContent = `${P.state.offset + 1}-${P.state.offset + items.length} / â‰¥${P.state.offset + items.length}`;
    } catch (err) {
      toast("åŠ è½½é¡¹ç›®å¤±è´¥ï¼š" + err.message, false);
    } finally {
      hideLoading();
    }
  },
  render(list) {
    P.els.table.innerHTML = list.map(p => {
      const st = `<span class="status ${p.status}">${p.status}</span>`;
      const selected = p.sqlid === P.state.selectedProjectId ? "selected" : "";
      return `<tr class="clickable ${selected}" data-p-id="${p.sqlid}">
        <td>${p.sqlid}</td>
        <td class="project-name-cell">
          <strong title="${p.name || ""}">${p.name || ""}</strong>
          <small class="help" title="${p.description || ""}">${p.description || ""}</small>
        </td>
        <td>${st}</td>
        <td>
          <button class="button small ghost" data-p-edit='${JSON.stringify(p)}' onclick="event.stopPropagation()">ç¼–è¾‘</button>
        </td>
      </tr>`;
    }).join("");
  },
  bind() {
    ["change", "keyup"].forEach(ev => {
      [P.els.q, P.els.status].forEach(el => el.addEventListener(ev, () => {
        P.state.offset = 0;
        P.state.limit = Number(P.els.limit.value);
        P.load();
      }));
    });
    P.els.limit.addEventListener("change", () => {
      P.state.limit = Number(P.els.limit.value);
      P.state.offset = 0;
      P.load();
    });
    P.els.refresh.addEventListener("click", () => P.load());
    P.els.prev.addEventListener("click", () => {
      P.state.offset = Math.max(0, P.state.offset - P.state.limit);
      P.load();
    });
    P.els.next.addEventListener("click", () => {
      P.state.offset += P.state.limit;
      P.load();
    });

    // ç‚¹å‡»é¡¹ç›®è¡Œ - æŸ¥çœ‹ä»»åŠ¡
    $("#p-table").addEventListener("click", (e) => {
      const row = e.target.closest("tr[data-p-id]");
      if (row) {
        const projectId = Number(row.dataset.pId);
        P.selectProject(projectId);
      }

      // ç¼–è¾‘æŒ‰é’®
      const btn = e.target.closest("button[data-p-edit]");
      if (btn) {
        const p = JSON.parse(btn.dataset.pEdit);
        P.openForm(p);
      }
    });

    // æ–°å»º
    P.els.btnNew.addEventListener("click", () => P.openForm(null));
  },
  selectProject(projectId) {
    P.state.selectedProjectId = projectId;
    // é‡æ–°æ¸²æŸ“é¡¹ç›®åˆ—è¡¨ä»¥æ˜¾ç¤ºé€‰ä¸­çŠ¶æ€
    P.load().then(() => {
      // åŠ è½½è¯¥é¡¹ç›®çš„ä»»åŠ¡
      T.loadByProject(projectId);
    });
  },
  openForm(p) {
    $("#mp-title").textContent = p ? `ç¼–è¾‘é¡¹ç›® #${p.sqlid}` : "æ–°å»ºé¡¹ç›®";
    const f = $("#mp-form");
    f.reset();
    f.sqlid.value = p?.sqlid || "";
    f.name.value = p?.name || "";
    f.status.value = p?.status || "planned";
    f.description.value = p?.description || "";
    f.project_manager_id.value = p?.project_manager_id ?? "";
    f.client_id.value = p?.client_id ?? "";
    f.budget.value = p?.budget ?? "";
    f.start_date.value = p?.start_date ? toISO(p.start_date) : "";
    f.deadline.value = p?.deadline ? toISO(p.deadline) : "";
    modalOpen("#modal-project");
  },
  async submitForm(ev) {
    ev.preventDefault();
    const f = ev.target;
    const payload = {
      name: f.name.value.trim(),
      status: f.status.value,
      description: str(f.description.value.trim()),
      project_manager_id: int(f.project_manager_id.value),
      client_id: int(f.client_id.value),
      budget: num(f.budget.value),
      start_date: f.start_date.value || null,
      deadline: f.deadline.value || null,
    };
    const id = f.sqlid.value ? Number(f.sqlid.value) : null;
    showLoading();
    try {
      if (id) {
        await Api.updateProject(id, payload);
        toast("é¡¹ç›®å·²æ›´æ–°");
      } else {
        await Api.createProject(payload);
        toast("é¡¹ç›®å·²åˆ›å»º");
      }
      modalClose("#modal-project");
      P.load();
    } catch (err) {
      toast("ä¿å­˜å¤±è´¥ï¼š" + err.message, false);
    } finally {
      hideLoading();
    }
  }
};

/* ========================= ä»»åŠ¡ï¼šåˆ—è¡¨/åˆ†é¡µ/è¡¨å• ========================= */
const T = {
  state: { offset: 0, limit: 20, currentProjectId: null },
  els: {
    q: $("#t-q"), status: $("#t-status"), priority: $("#t-priority"),
    after: $("#t-after"), before: $("#t-before"), sort: $("#t-sort"), limit: $("#t-limit"),
    refresh: $("#t-refresh"), table: $("#t-table"),
    meta: $("#t-meta"), prev: $("#t-prev"), next: $("#t-next"),
    btnNew: $("#t-new"),
    title: $("#task-title"),
    loading: $("#t-loading"),
    empty: $("#t-empty"),
    tableWrap: $("#t-table-wrap"),
    pager: $("#t-pager"),
  },
  qs() {
    return {
      q: T.els.q.value.trim() || "",
      sqlproject_id: T.state.currentProjectId || "",
      status: T.els.status.value || "",
      priority: T.els.priority.value || "",
      due_after: T.els.after.value || "",
      due_before: T.els.before.value || "",
      sort: T.els.sort.value,
      limit: T.state.limit,
      offset: T.state.offset
    };
  },
  async loadByProject(projectId) {
    T.state.currentProjectId = projectId;
    T.state.offset = 0;
    
    // ç«‹å³æ¸…ç©ºå¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    T.els.empty.style.display = "none";
    T.els.tableWrap.style.display = "none";
    T.els.pager.style.display = "none";
    T.els.table.innerHTML = "";
    showSectionLoading("#t-loading");
    
    // æ›´æ–°æ ‡é¢˜å’ŒæŒ‰é’®çŠ¶æ€
    T.els.title.textContent = `é¡¹ç›® #${projectId} çš„ä»»åŠ¡åˆ—è¡¨`;
    T.els.btnNew.disabled = false;
    T.els.refresh.disabled = false;
    
    // åŠ è½½æ•°æ®
    await T.load();
  },
  async load() {
    if (!T.state.currentProjectId) {
      T.showEmpty();
      return;
    }
    
    showSectionLoading("#t-loading");
    try {
      const data = await Api.listTasks(T.qs());
      const items = data.items || [];
      T.render(items);
      T.els.meta.textContent = `${T.state.offset + 1}-${T.state.offset + items.length} / â‰¥${T.state.offset + items.length}`;
      
      // æ˜¾ç¤ºè¡¨æ ¼å’Œåˆ†é¡µ
      hideSectionLoading("#t-loading");
      T.els.empty.style.display = "none";
      T.els.tableWrap.style.display = "block";
      T.els.pager.style.display = "flex";
    } catch (err) {
      hideSectionLoading("#t-loading");
      toast("åŠ è½½ä»»åŠ¡å¤±è´¥ï¼š" + err.message, false);
    }
  },
  showEmpty() {
    hideSectionLoading("#t-loading");
    T.els.empty.style.display = "block";
    T.els.tableWrap.style.display = "none";
    T.els.pager.style.display = "none";
    T.els.title.textContent = "é€‰æ‹©é¡¹ç›®æŸ¥çœ‹ä»»åŠ¡";
    T.els.btnNew.disabled = true;
    T.els.refresh.disabled = true;
  },
  render(list) {
    T.els.table.innerHTML = list.map(t => {
      const st = `<span class="status ${t.status}">${t.status}</span>`;
      const pr = t.priority ? `<span class="priority ${t.priority}">${t.priority}</span>` : "â€”";
      const hrs = `${t.estimated_hours ?? "â€”"} / ${t.actual_hours ?? "â€”"}`;
      const due = t.due_date || "â€”";
      return `<tr>
        <td>${t.sqlid}</td>
        <td class="task-name-cell">
          <strong title="${t.task_name || ""}">${t.task_name || ""}</strong>
          <small class="help" title="${t.description || ""}">${t.description || ""}</small>
        </td>
        <td>${st}</td>
        <td>${pr}</td>
        <td>${hrs}</td>
        <td>${due}</td>
        <td>
          <div class="row" style="gap:4px">
            <button class="button small ghost" data-t-edit='${JSON.stringify(t)}'>ç¼–è¾‘</button>
            <select class="input" style="min-height:30px;font-size:12px" data-t-status="${t.sqlid}">
              <option ${t.status === "todo" ? "selected" : ""}>todo</option>
              <option ${t.status === "doing" ? "selected" : ""}>doing</option>
              <option ${t.status === "done" ? "selected" : ""}>done</option>
              <option ${t.status === "blocked" ? "selected" : ""}>blocked</option>
            </select>
            <button class="button small danger" data-t-del="${t.sqlid}">åˆ é™¤</button>
          </div>
        </td>
      </tr>`;
    }).join("");
  },
  bind() {
    ["change", "keyup"].forEach(ev => {
      [T.els.q, T.els.status, T.els.priority, T.els.after, T.els.before, T.els.sort]
        .forEach(el => el.addEventListener(ev, () => {
          if (T.state.currentProjectId) {
            T.state.offset = 0;
            T.state.limit = Number(T.els.limit.value);
            T.load();
          }
        }));
    });
    T.els.limit.addEventListener("change", () => {
      if (T.state.currentProjectId) {
        T.state.limit = Number(T.els.limit.value);
        T.state.offset = 0;
        T.load();
      }
    });
    T.els.refresh.addEventListener("click", () => T.load());
    T.els.prev.addEventListener("click", () => {
      T.state.offset = Math.max(0, T.state.offset - T.state.limit);
      T.load();
    });
    T.els.next.addEventListener("click", () => {
      T.state.offset += T.state.limit;
      T.load();
    });

    // è¡Œå†…æ“ä½œ
    $("#t-table").addEventListener("click", (e) => {
      const btn = e.target.closest("button,select");
      if (!btn) return;
      if (btn.dataset.tEdit) {
        const t = JSON.parse(btn.dataset.tEdit);
        T.openForm(t);
      }
      if (btn.dataset.tDel) {
        const id = Number(btn.dataset.tDel);
        if (confirm(`ç¡®å®šåˆ é™¤ä»»åŠ¡ #${id}ï¼Ÿ`)) {
          showLoading();
          Api.deleteTask(id).then(() => {
            toast("å·²åˆ é™¤ä»»åŠ¡ #" + id);
            T.load();
          }).catch(err => toast("åˆ é™¤å¤±è´¥ï¼š" + err.message, false))
            .finally(() => hideLoading());
        }
      }
    });

    // çŠ¶æ€åˆ‡æ¢
    $("#t-table").addEventListener("change", async (e) => {
      const sel = e.target.closest("select[data-t-status]");
      if (!sel) return;
      const id = Number(sel.dataset.tStatus);
      showLoading();
      try {
        await Api.patchTaskStatus(id, sel.value);
        toast("çŠ¶æ€å·²æ›´æ–°");
      } catch (err) {
        toast("æ›´æ–°çŠ¶æ€å¤±è´¥ï¼š" + err.message, false);
      } finally {
        hideLoading();
      }
    });

    // æ–°å»º
    T.els.btnNew.addEventListener("click", () => T.openForm(null));
  },
  openForm(t) {
    $("#mt-title").textContent = t ? `ç¼–è¾‘ä»»åŠ¡ #${t.sqlid}` : "æ–°å»ºä»»åŠ¡";
    const f = $("#mt-form");
    f.reset();
    f.sqlid.value = t?.sqlid || "";
    f.sqlproject_id.value = t?.sqlproject_id || T.state.currentProjectId || "";
    f.task_name.value = t?.task_name || "";
    f.description.value = t?.description || "";
    f.assignee_id.value = t?.assignee_id ?? "";
    f.priority.value = t?.priority ?? "";
    f.estimated_hours.value = t?.estimated_hours ?? "";
    f.actual_hours.value = t?.actual_hours ?? "";
    f.status.value = t?.status || "todo";
    f.due_date.value = t?.due_date ? toISO(t.due_date) : "";
    modalOpen("#modal-task");
  },
  async submitForm(ev) {
    ev.preventDefault();
    const f = ev.target;
    const id = f.sqlid.value ? Number(f.sqlid.value) : null;
    const payload = {
      sqlproject_id: Number(f.sqlproject_id.value),
      task_name: f.task_name.value.trim(),
      description: str(f.description.value.trim()),
      assignee_id: int(f.assignee_id.value),
      priority: str(f.priority.value || ""),
      estimated_hours: num(f.estimated_hours.value),
      actual_hours: num(f.actual_hours.value),
      status: f.status.value,
      due_date: f.due_date.value || null,
    };
    showLoading();
    try {
      if (id) {
        await Api.updateTask(id, payload);
        toast("ä»»åŠ¡å·²æ›´æ–°");
      } else {
        await Api.createTask(payload);
        toast("ä»»åŠ¡å·²åˆ›å»º");
      }
      modalClose("#modal-task");
      T.load();
    } catch (err) {
      toast("ä¿å­˜å¤±è´¥ï¼š" + err.message, false);
    } finally {
      hideLoading();
    }
  }
};

/* ========================= ç¤ºä¾‹æ•°æ®ï¼ˆå¯é€‰ï¼‰ ========================= */
$("#seedBtn").addEventListener("click", async () => {
  if (!confirm("ä¸ºå¿«é€Ÿä½“éªŒï¼Œå°†åˆ›å»º 2 ä¸ªé¡¹ç›® + è‹¥å¹²ä»»åŠ¡ã€‚ç»§ç»­ï¼Ÿ")) return;
  showLoading();
  try {
    const p1 = await Api.createProject({
      name: "ç½‘ç«™é‡æ„",
      status: "active",
      budget: 50000,
      start_date: "2025-09-01",
      deadline: "2025-12-31",
      description: "å‰åç«¯ä¸€ä½“åŒ–é‡æ„"
    });
    const p2 = await Api.createProject({
      name: "ç§»åŠ¨ç«¯ä¸Šçº¿",
      status: "planned",
      budget: 20000,
      start_date: "2025-10-10",
      deadline: "2026-01-10",
      description: "å°ç¨‹åº & App"
    });
    await Api.createTask({
      sqlproject_id: p1.sqlid,
      task_name: "æ•°æ®åº“å»ºæ¨¡",
      status: "doing",
      priority: "high",
      estimated_hours: 16,
      due_date: "2025-10-01"
    });
    await Api.createTask({
      sqlproject_id: p1.sqlid,
      task_name: "æ¥å£è”è°ƒ",
      status: "todo",
      priority: "medium",
      estimated_hours: 24,
      due_date: "2025-10-15"
    });
    await Api.createTask({
      sqlproject_id: p2.sqlid,
      task_name: "UI è®¾è®¡è§„èŒƒ",
      status: "todo",
      priority: "low",
      estimated_hours: 12,
      due_date: "2025-10-20"
    });
    toast("å·²åˆ›å»ºç¤ºä¾‹æ•°æ®");
    P.load();
  } catch (err) {
    toast("åˆ›å»ºç¤ºä¾‹æ•°æ®å¤±è´¥ï¼š" + err.message, false);
  } finally {
    hideLoading();
  }
});

/* ========================= è¡¨å•æäº¤ç»‘å®š & åˆå§‹åŒ– ========================= */
$("#mp-form").addEventListener("submit", P.submitForm);
$("#mt-form").addEventListener("submit", T.submitForm);
P.bind();
T.bind();
P.load();
T.showEmpty(); // åˆå§‹æ˜¾ç¤ºç©ºçŠ¶æ€
</script>
</body>
</html>